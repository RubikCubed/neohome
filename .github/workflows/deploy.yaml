# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Deploy

concurrency: deploy

on:
  push:
    branches:
      - hugo

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Set up cachix
        uses: cachix/cachix-action@master
        with:
          name: viperml
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        run: cp -vrL $(nix build -L --print-out-paths --no-link) ./public

      - uses: amondnet/vercel-action@v20
        name: "Deploy to Vercel"
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID}}
          vercel-project-id: ${{ secrets.PROJECT_ID}}
          vercel-args: "--prod "
